SELECT LYV, ISNULL(Type, '')  Type,Name, Name_ID,Name_DepID, Name_DepName, Agent, Agent_ID, Purpose, FLocation, Convert(varchar,BTime,120) as BTime,
	ISNULL(Convert(varchar,ETime,120), '') as ETime, Days,Journey,ISNULL(TransportType, '') TransportType, ISNULL(ApplyCar, '') ApplyCar, Remark,
	USERID, USERDATE,ISNULL( (Select ISNULL(FILE_NAME, '') +'   ' from TB_EB_FILE_STORE where  FILE_GROUP_ID = TB_WKF_TASK.ATTACH_ID   FOR XML PATH ('')), N'Kh√¥ng') FILENAME, 
	ApproveData.*
FROM LYV_BusinessTrip
LEFT JOIN TB_WKF_TASK on LYV_BusinessTrip.LYV=TB_WKF_TASK.DOC_NBR
LEFT JOIN (
  SELECT 
                MAX(APPNAME) AS Applicant, 
                MAX(CAST(BEGIN_TIME AS DATE)) AS ApplicantDate,  
				MAX(USER_GUID) AS Applicant_USER_GUID,
				MAX(FILE_ID) AS Applicant_FILE_ID,
				MAX(FILE_PATH) AS Applicant_FILE_PATH,
				MAX(FILE_CONTENT_TYPE) AS Applicant_FILE_CONTENT_TYPE,
				MAX(FILE_NAME) AS Applicant_FILE_NAME,

                MAX(CASE WHEN SITE_CODE='S1' THEN NAME END) AS Supervisor, 
                MAX(CASE WHEN SITE_CODE='S1' THEN FINISH_TIME END) AS SupervisorDate,  
				MAX(CASE WHEN SITE_CODE='S1' THEN USER_GUID END) AS Supervisor_USER_GUID,
				MAX(CASE WHEN SITE_CODE='S1' THEN FILE_ID END) AS Supervisor_FILE_ID,
				MAX(CASE WHEN SITE_CODE='S1' THEN FILE_PATH END) AS Supervisor_FILE_PATH,
				MAX(CASE WHEN SITE_CODE='S1' THEN FILE_CONTENT_TYPE END) AS Supervisor_FILE_CONTENT_TYPE,
				MAX(CASE WHEN SITE_CODE='S1' THEN FILE_NAME END) AS Supervisor_FILE_NAME,

                MAX(CASE WHEN SITE_CODE='S2' THEN NAME END) AS Supervisor1, 
                MAX(CASE WHEN SITE_CODE='S2' THEN FINISH_TIME END) AS SupervisorDate1,  
				MAX(CASE WHEN SITE_CODE='S2' THEN USER_GUID END) AS Supervisor1_USER_GUID,
				MAX(CASE WHEN SITE_CODE='S2' THEN FILE_ID END) AS Supervisor1_FILE_ID,
				MAX(CASE WHEN SITE_CODE='S2' THEN FILE_PATH END) AS Supervisor1_FILE_PATH,
				MAX(CASE WHEN SITE_CODE='S2' THEN FILE_CONTENT_TYPE END) AS Supervisor1_FILE_CONTENT_TYPE,
				MAX(CASE WHEN SITE_CODE='S2' THEN FILE_NAME END) AS Supervisor1_FILE_NAME,

                MAX(CASE WHEN SITE_CODE='S3' THEN NAME END) AS Manager, 
                MAX(CASE WHEN SITE_CODE='S3' THEN FINISH_TIME END) AS ManagerDate, 
				MAX(CASE WHEN SITE_CODE='S3' THEN USER_GUID END) AS Manager_USER_GUID,
				MAX(CASE WHEN SITE_CODE='S3' THEN FILE_ID END) AS Manager_FILE_ID,
				MAX(CASE WHEN SITE_CODE='S3' THEN FILE_PATH END) AS Manager_FILE_PATH,
				MAX(CASE WHEN SITE_CODE='S3' THEN FILE_CONTENT_TYPE END) AS Manager_FILE_CONTENT_TYPE,
				MAX(CASE WHEN SITE_CODE='S3' THEN FILE_NAME END) AS Manager_FILE_NAME,

                MAX(CASE WHEN SITE_CODE='HR' THEN NAME END) AS HR, 
                MAX(CASE WHEN SITE_CODE='HR' THEN FINISH_TIME END) AS HRDate, 
				MAX(CASE WHEN SITE_CODE='HR' THEN USER_GUID END) AS HR_USER_GUID,
				MAX(CASE WHEN SITE_CODE='HR' THEN FILE_ID END) AS HR_FILE_ID,
				MAX(CASE WHEN SITE_CODE='HR' THEN FILE_PATH END) AS HR_FILE_PATH,
				MAX(CASE WHEN SITE_CODE='HR' THEN FILE_CONTENT_TYPE END) AS HR_FILE_CONTENT_TYPE,
				MAX(CASE WHEN SITE_CODE='HR' THEN FILE_NAME END) AS HR_FILE_NAME,

                MAX(CASE WHEN SITE_CODE='GD' THEN NAME END) AS GD, 
                MAX(CASE WHEN SITE_CODE='GD' THEN FINISH_TIME END) AS GDDate,
				MAX(CASE WHEN SITE_CODE='GD' THEN USER_GUID END) AS GD_USER_GUID,
				MAX(CASE WHEN SITE_CODE='GD' THEN FILE_ID END) AS GD_FILE_ID,
				MAX(CASE WHEN SITE_CODE='GD' THEN FILE_PATH END) AS GD_FILE_PATH,
				MAX(CASE WHEN SITE_CODE='GD' THEN FILE_CONTENT_TYPE END) AS GD_FILE_CONTENT_TYPE,
				MAX(CASE WHEN SITE_CODE='GD' THEN FILE_NAME END) AS GD_FILE_NAME,

				MAX(CASE WHEN SITE_CODE='CNBP' THEN NAME END) AS CNBP, 
                MAX(CASE WHEN SITE_CODE='CNBP' THEN FINISH_TIME END) AS CNBPDate,
				MAX(CASE WHEN SITE_CODE='CNBP' THEN USER_GUID END) AS CNBP_USER_GUID,
				MAX(CASE WHEN SITE_CODE='CNBP' THEN FILE_ID END) AS CNBP_FILE_ID,
				MAX(CASE WHEN SITE_CODE='CNBP' THEN FILE_PATH END) AS CNBP_FILE_PATH,
				MAX(CASE WHEN SITE_CODE='CNBP' THEN FILE_CONTENT_TYPE END) AS CNBP_FILE_CONTENT_TYPE,
				MAX(CASE WHEN SITE_CODE='CNBP' THEN FILE_NAME END) AS CNBP_FILE_NAME
            FROM 
                ( 
                    SELECT 
						CASE 
							WHEN TB_WKF_TASK_NODE.ACTUAL_SIGNER <> TB_WKF_TASK_NODE.ORIGINAL_SIGNER 
							THEN TB_EB_USER.NAME + '(*)' 
							ELSE TB_EB_USER.NAME 
						END AS NAME, 
						CAST(FINISH_TIME AS DATE) FINISH_TIME, 
						US.NAME AS APPNAME, 
						TB_WKF_TASK.BEGIN_TIME,
						ROW_NUMBER() OVER (PARTITION BY FINISH_TIME ORDER BY FINISH_TIME DESC) AS RowID, 
						TB_WKF_TASK_TRIGGER_RECORD.SITE_CODE,
						TB_EB_USER.ACCOUNT,
						EU.USER_GUID, 
						EFS.FILE_ID, 
						REPLACE(EFS.FILE_PATH, '\', '/') AS FILE_PATH, 
						EFS.FILE_CONTENT_TYPE, 
						EFS.FILE_NAME
					FROM 
						TB_WKF_TASK
					LEFT JOIN 
						TB_WKF_TASK_NODE ON TB_WKF_TASK.TASK_ID = TB_WKF_TASK_NODE.TASK_ID
					LEFT JOIN 
						TB_WKF_TASK_TRIGGER_RECORD ON TB_WKF_TASK_TRIGGER_RECORD.SITE_ID = TB_WKF_TASK_NODE.SITE_ID AND TB_WKF_TASK_NODE.TASK_ID = TB_WKF_TASK_TRIGGER_RECORD.TASK_ID
					LEFT JOIN 
						TB_EB_USER ON TB_EB_USER.USER_GUID = TB_WKF_TASK_NODE.ACTUAL_SIGNER
					LEFT JOIN 
						TB_EB_USER US ON US.USER_GUID = TB_WKF_TASK.AGENT_USER
					LEFT JOIN 
						TB_EB_USER EU ON TB_EB_USER.ACCOUNT = EU.ACCOUNT
					LEFT JOIN 
						TB_EB_EMPL_ELEC_SIGN EES ON EU.USER_GUID = EES.USER_GUID AND EES.DEFAULT_SIGN = 1
					LEFT JOIN 
						TB_EB_FILE_STORE EFS ON EES.ELEC_SIGN = EFS.FILE_GROUP_ID
					WHERE 
						ACTUAL_SIGNER IS NOT NULL 
						AND SITE_CODE NOT IN ('Applicant', 'END_FORM') 
						AND TB_WKF_TASK.DOC_NBR = 'LYV240900001'
                ) AS ApproveData 
            WHERE 
                RowID = 1 
 ) AS ApproveData ON 1 = 1 
 WHERE LYV='LYV240900001'
